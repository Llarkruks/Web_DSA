<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><!--Para no tener caracteres raros -->
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Para escalar y dimensionar la página -->
    <title>GitHub User Lookup</title> <!-- título de la pestaña del navegador -->

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"> <!-- con estas dos lineas se incluye la hoja de estilos de boostrats desde un CDN -->

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <!-- carga jquery desde un CDN-->
</head>
<body class="bg-light"><!-- Aquí empieza el cuerpo de la página -->

<div class="container mt-5"><!--el container da margenes y centra el contenido y el mt-5 añade un espacio arriba de valor 5 -->
    <div class="row justify-content-center"><!-- creamos una fila dentro del grid de boostrap y centra horizontalmente el contenido de la fila -->
        <div class="col-md-6"><!-- crea una columna que ocupa 6 de 12 columnas -->
            <div class="card shadow-sm"><!-- card da estilo de tarjeta y shadow-sm agrega una sombra para dar profundidad -->
                <div class="card-header text-center bg-primary text-white"><!-- card header es la parte superior de la tarjeta (titulo), text-center centra el texto
                                                                                bg-primary pone el color azul (=primary) y text-white pone el texto blanco-->
                    <h4>GitHub Username Lookup</h4><!-- es el título del formulario -->
                </div>
                <div class="card-body"> <!-- empieza la parte de contenido principal de la tarjeta-->
                    <form id="githubForm"><!-- formulario con ID githubform -->
                        <div class="mb-3"><!-- añade espacio debajo de este bloque -->
                            <label for="username" class="form-label">Enter GitHub Username</label>
                            <input type="text" class="form-control" id="username" placeholder="e.g. torvalds" required><!-- campo de texto, placeholder es el
                                                                                                                            texto que aparece de ejemploy required
                                                                                                                            obliga a que no se deje en blanco-->
                        </div>
                        <div class="d-grid"><!-- hace que el botón ocupe el ancho completo-->
                            <button type="submit" class="btn btn-success">Submit</button>
                        </div>
                    </form>
                    <div id="result" class="mt-4"></div><!--Espacio vacío donde después se mostrará el resultado con jQuery-->

                    <!-- Tabla de repos -->
                    <div class="table-responsive d-none" id="reposWrapper">
                        <table class="table table-striped align-middle" id="reposTable">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col" style="min-width: 220px;">Description</th>
                                <th scope="col" class="text-end">Stars (followers)</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Loader -->
                    <div id="loader" class="text-center d-none">
                        <div class="spinner-border" role="status" aria-hidden="true"></div>
                        <div class="mt-2">Loading repositories…</div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>//Abre un bloque de código javascript
$(document).ready(function () {
    const $form = $("#githubForm");
    const $username = $("#username");
    const $result = $("#result");
    const $loader = $("#loader");
    const $reposWrapper = $("#reposWrapper");
    const $reposTableBody = $("#reposTable tbody");

    function showMessage(html) {
        $result.html(html);
    }
    function clearMessage() {
        $result.empty();
    }
    function showLoader(show) {
        $loader.toggleClass("d-none", !show);
    }
    function showTable(show) {
        $reposWrapper.toggleClass("d-none", !show);
    }
    function sanitize(text) {
        // Evita 'null' y recorta
        return (text ?? "").toString().trim();
    }

    async function fetchAllRepos(user) {
        // GitHub pagina resultados; pedimos hasta 100 por página (máximo permitido)
        // Si el usuario tiene más de 100 repos, repetimos hasta agotar.
        const perPage = 100;
        let page = 1;
        let all = [];
        while (true) {
            const url = `https://api.github.com/users/${encodeURIComponent(
                user
            )}/repos?per_page=${perPage}&page=${page}&sort=updated`;
            const res = await fetch(url, {
                headers: {
                    "Accept": "application/vnd.github+json",
                },
            });
            if (res.status === 404) {
                throw new Error("not_found");
            }
            if (!res.ok) {
                // Otros errores (rate limit, 500, etc.)
                throw new Error(`http_${res.status}`);
            }
            const batch = await res.json();
            all = all.concat(batch);
            if (batch.length < perPage) break; // no hay más páginas
            page++;
            // Protección simple para no entrar en bucles raros
            if (page > 10) break;
        }
        return all;
    }

    function renderReposTable(repos) {
        $reposTableBody.empty();

        if (!repos.length) {
            showTable(false);
            showMessage(
                `<div class="alert alert-warning mb-0">This user has no public repositories.</div>`
            );
            return;
        }

        // Orden opcional por estrellas descendente para destacar los más populares
        repos.sort((a, b) => (b.stargazers_count || 0) - (a.stargazers_count || 0));

        const rows = repos.map((repo) => {
            const name = sanitize(repo.name);
            const desc = sanitize(repo.description) || "<em class='text-muted'>No description</em>";
            const stars = repo.stargazers_count ?? 0;
            const htmlUrl = repo.html_url;

            return `
            <tr>
              <td>
                <a href="${htmlUrl}" target="_blank" rel="noopener noreferrer">${name}</a>
              </td>
              <td>${desc}</td>
              <td class="text-end">${stars.toLocaleString()}</td>
            </tr>
          `;
        });

        $reposTableBody.html(rows.join(""));
        showTable(true);
    }

    $form.on("submit", async function (e) {
        e.preventDefault();
        clearMessage();
        showTable(false);

        const user = $username.val().trim();

        if (!user) {
            showMessage(
                `<div class="alert alert-danger">Please enter a valid username.</div>`
            );
            return;
        }

        // Mostrar loader
        showLoader(true);
        showMessage(
            `<div class="alert alert-info mb-3">Showing repositories for <strong>${user}</strong>…</div>`
        );

        try {
            const repos = await fetchAllRepos(user);
            renderReposTable(repos);
        } catch (err) {
            showTable(false);
            if (err.message === "not_found") {
                showMessage(
                    `<div class="alert alert-danger">User <strong>${user}</strong> was not found.</div>`
                );
            } else if (err.message.startsWith("http_403")) {
                showMessage(
                    `<div class="alert alert-warning">Rate limit reached. Please try again later.</div>`
                );
            } else {
                showMessage(
                    `<div class="alert alert-danger">Oops! There was a problem fetching repositories. (${err.message})</div>`
                );
            }
        } finally {
            showLoader(false);
        }
    });
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>